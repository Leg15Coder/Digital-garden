
***Подключение к СУБД $\rightarrow$ отправка запроса в СУБД в формате SQL $\rightarrow$ парсер проверяет корректность синтаксиса $\rightarrow$ парсер формирует дерево запроса $\rightarrow$ система переписывания формирует обновлённое дерево запроса $\rightarrow$ планировщик определяет последовательность выполнения запроса $\rightarrow$ обработчик рекурсивно обходит запрос согласно плану и получает результат***

#### Подключение к [[Модели хранения данных#^1d1485|СУБД]]

1. Клиентский процесс обращается к главному
серверному процессу;
2. Главный серверный процесс создает новый
процесс при запросе соединения;
3. Когда соединение установлено, клиент может
отправить на сервер запрос;
4. На этом этапе обработки запроса не происходит.

#### отправка запроса в [[Модели хранения данных#^1d1485|СУБД]]

1. Запрос будет передан в виде обычного текста;
2. На этом этапе обработки запроса не происходит.

#### Парсинг запроса

1. Лексический анализатор разбирает текст запроса на лексемы (такие как ключевые слова, строковые и числовые литералы и т. п.), а синтаксический анализатор убеждается, что полученный набор лексем соответствует грамматике языка.
2. Если запрос правильный, строится дерево запроса и передаётся дальше, иначе возвращается ошибка.
3. Лексический и синтаксический анализ реализован с применением следующих средств:
	- Bison – программа для автоматического создания синтаксических анализаторов по описанию грамматики.
	- Flex (fast lexical analyzer) – генератор лексических анализаторов.
4. Происходит проверка наличия доступа у пользователя к запрашиваемым данным.
5. Семантический анализатор получает от синтаксического анализатора дерево разбора и перестраивает его, дополняя ссылками на конкретные объекты базы данных, информацией о типах данных и т.п.
6. Далее запрос может трансформироваться (переписываться) с целью оптимизации и удобства обработки. Например, могут заменяться в дереве разбора имена представлений на поддеревья, соответствующие запросу этого представления.

Упрощённый вид дерева запросов:
![[Pasted image 20250506144135.png]]
*Дерево разбора отражает синтаксическую структуру
запроса, но ничего не говорит о том, в каком порядке
будут выполнены операции.*

#### Планировщик

***Тезис: определенный SQL-запрос можно выполнить разными
способами, при этом получая одни и те же результаты.***

- Планировщик указывает конкретный способ выполнения запроса.
- План выполнения запроса также представляется в виде дерева, но его узлы содержат описание физических операций над данными – это вариант реализации того, что описано в дереве запроса.

Упрощённый вид дерева планировщика:
![[Pasted image 20250506144828.png]]

Оператор `EXPLAIN` ([[Основные понятия реляционной алгебры|PostgreSQL]]) способен выводить план выполнения, генерируемый планировщиком. Он показывает:
- как будут сканироваться таблицы, затрагиваемые оператором – последовательно, с использованием индекса и т.д.;
- какой алгоритм соединения будет выбран для объединения считанных из таблиц строк;
- ожидаемую “стоимость” выполнения запроса.
- Оператор **отсутствует** в стандарте SQL
Синтаксис оператора:
```sql
EXPLAIN [ ( option [, ...] ) ] statement
EXPLAIN [ ANALYZE ] [ VERBOSE ] statement
-- where option can be one of:
	ANALYZE [ boolean ] -- запуск запроса и показ реальной статы
	VERBOSE [ boolean ] -- дополнительная информация по плану
	COSTS [ boolean ] -- примерная “стоимость” выполнения
	SETTINGS [ boolean ] -- вывод конфигурационных параметров
	GENERIC_PLAN [ boolean ]
	BUFFERS [ boolean ]
	WAL [ boolean ]
	TIMING [ boolean ]
	SUMMARY [ boolean ] -- общая информация по запросу
	FORMAT { TEXT | XML | JSON | YAML }
```
