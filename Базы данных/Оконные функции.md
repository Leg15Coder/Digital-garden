
==Опр.== **Окно** - набор или группа [[Основные понятия реляционной алгебры#^b857a6|кортежей]] (строк) [[Основные понятия реляционной алгебры#^65c8e5|отношения]] (таблицы)

==Опр.== **Оконная функция** - функция, которая выполняет вычисления по строкам в пределах окна без [[Агрегирующие функции|агрегации]] строк

Оконные функции...
- Действуют подобно [[Агрегирующие функции|агрегатным функциям]], но не уменьшают степень детализации
- Принимают в качестве аргумента столбец промежуточного результата вычисления и возвращают тоже столбец

==Опр.== **Ранжирование** - упорядочивание строк по значению некоторого атрибута

==Опр.== **Ранг** - номер строки после ранжирования (вычисляется относительно данного ранжирования)

==Опр.== **Секция** – набор строк из разбиения данных

==Опр.== **Фрейм** – набор строк, участвующий в вычислении функции для данной (рассматриваемой) строки

##### Синтаксис (в [[SQL]])

Если использовать оконную функцию сразу:

```sql
OVER (
	[ <PARTITION BY clause> ]  -- группировка
	[ <ORDER BY clause> ]      -- сортировка
	[ <ROWS or RANGE clause> ] -- фреймы
)
```

Если декларировать функцию:

```sql
WINDOW <name> AS (
	[ <PARTITION BY clause> ]  -- группировка
	[ <ORDER BY clause> ]      -- сортировка
	[ <ROWS or RANGE clause> ] -- фреймы
)
```

- Внутри `OVER` необходимо указать поле таблицы, по которому будет скользить окно, и правило, по которому строки будут секционироваться.
- `OVER` может многократно использоваться в одном [[Операторы в SQL|SELECT]] с разными разделениями и сортировками.
- Разбивает множество на группы по критериям.
- Агрегации применяются к группам независимо.
- Если не указать конструкцию секционирования, все множество считается одной группой: `OVER` содержит все строки из результирующего набора.

##### Функции ранжирования

| Функция        | Описание                                                                                                                          |
| -------------- | --------------------------------------------------------------------------------------------------------------------------------- |
| `row_number()` | порядковый уникальный номер строки                                                                                                |
| `dense_rank()` | ранг строки (одинаковый у равных строк, у последовательных значений поля сортировки отличается на 1)                              |
| `rank()`       | ранг строки с пропусками (у последовательных значений поля сортировки отличается на количество строк с одинаковым значением поля) |
| `ntile(n)`     | разбивает все строки на n групп и возвращает номер группы, в<br>которую попала строка                                             |

##### Функции смещения

| Функция                             | Описание                                                                                     |
| ----------------------------------- | -------------------------------------------------------------------------------------------- |
| `lag(attr, offset, default_value)`  | Предыдущее значение поля `attr` со сдвигом `offset` (при отсутствии берётся `default_value`) |
| `lead(attr, offset, default_value)` | Следующее значение поля `attr` со сдвигом `offset` (при отсутствии берётся `default_value`)  |
| `first_value(value)`                | Первое значение в секции с первой по текущую строку (или во фрейме)                          |
| `last_value(value)`                 | Последнее значение во фрейме                                                                 |
| `nth_value(value, n)`               | Значение `value` из n-й строки фрейма                                                        |

##### Скользящие расчёты

Синтаксис:

```sql
<функция>() OVER (
  ORDER BY ...
  ROWS BETWEEN 
	  X (UNBOUNDED) PRECEDING 
		  AND 
	  Y (UNBOUNDED) FOLLOWING
)
```

-> Окно скользит от X-й строки до текущей до Y-й строки после текущей

| Ключевое слово             | Значение                                                                  |
| -------------------------- | ------------------------------------------------------------------------- |
| `X PRECEDING`              | Строка на X позиций **до** текущей                                        |
| `Y FOLLOWING`              | Строка на Y позиций **после** текущей                                     |
| `CURRENT ROW`              | Текущая строка                                                            |
| `UNBOUNDED PRECEDING`      | Самое начало окна                                                         |
| `UNBOUNDED FOLLOWING`      | Самый конец окна                                                          |

Помимо ключевого слова `ROWS` есть слова `RANGE` и `GROUPS`, которые скользят не по позициям,  а по свойствам значений (диапазон значений или ранг значений)

- **`ROWS`** — работает с **позициями** (строками по порядку).

- `RANGE` позволяет включать строки с похожими значениями, а не позициями.

- `GROUPS` работает на основе **рангов** значений в `ORDER BY`, группируя одинаковые значения в одну позицию.

| Пример              | `ROWS`                         | `RANGE`                                       | `GROUPS`                             |
| ------------------- | ------------------------------ | --------------------------------------------- | ------------------------------------ |
| `3 PRECEDING`       | 3 строки до текущей            | Все строки с близкими значениями              | 3 группы значений до текущей         |
| `CURRENT ROW`       | Только текущая строка          | Все строки с тем же значением `ORDER BY`      | Вся текущая группа                   |
| `UNBOUNDED`         | Всё до начала/конца            | Всё по значениям до/после                     | Все группы до начала/конца           |

Примеры: 

1. Скользящее среднее из 2 предыдущих и 2 следующих строк:

```sql
avg(salary) OVER (
  ORDER BY hire_date
  ROWS BETWEEN 2 PRECEDING AND 2 FOLLOWING
)
```


2. Все строки с датой в пределах 7 дней

```sql
sum(sales) OVER (
  ORDER BY sale_date
  RANGE BETWEEN INTERVAL '7' DAY PRECEDING AND CURRENT ROW
)
```


3. 1 группа до и 1 после текущей

```sql
sum(sales) OVER (
  ORDER BY category
  GROUPS BETWEEN 1 PRECEDING AND 1 FOLLOWING
)
```
