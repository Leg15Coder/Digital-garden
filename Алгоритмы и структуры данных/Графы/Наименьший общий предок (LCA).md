==Опр.== **Наименьший общий предок (LCA)** - ближайшая общая (для двух данных вершин) вершина дерева, которая лежит на пути к корню.

## Метод двоичных подъёмов
### Алгоритм
#### Предподсчёт

Будем использовать [[Динамическое программирование|динамическое программирование]].

1) $dp[v][i]$ - вершина, которая на $2^i$ выше $v$. (Если высота $v$ меньше $2^i$, то эта вершина - корень)
2) База: $dp[v][0]$ - предок $v$
3) Переход: $dp[v][i] = dp[dp[v][i-1]][i-1]$
4) Порядок пересчёта: внешний цикл по $i$ от 1 до $\log_2 |V|$, внутренний цикл по $v$.

#### Ответ на запрос

- Запросы вида $LCA(u, v)$
- Пусть $h$ - массив высот вершин

1) боо $h[u] < h[v]$, пусть $diff = h[v] - h[u]$.
2) Пока $diff > 0$:
	1) Если $diff \equiv 1 \mod 2$, то $u = dp[u][0]$ и $diff = diff - 1$
	2) Иначе $u = dp[u][1]$ и $diff = diff / 2$
3) Пусть $k = \lceil\log_2 |V| \rceil$. Пока $k \neq 0$:
	1) Если $dp[u][k] \neq dp[v][k]$, то $u = dp[u][k]$ и $v = dp[v][k]$
	2) Иначе $k = k - 1$
4) LCA лежит в $dp[u][0]$

### Корректность

### Асимптотика

1) По времени

	1) Предподсчёт
		Расчёт ячейки - $O(1)$, пересчёт - $O(|V|\log |V|)$

	2) Ответ на запрос
		Уравнивание высот за $O(\log_2 |V|)$, прыжков при поиске общего предка тоже $O(\log_2 |V|)$

Итоговая асимптотика по времени: 
1) Предподсчёт за $O(|V|\log |V|)$
2) Ответ на запрос за $O(\log |V|)$

## Сведение LCA к RMQ

1) Запустим DFS от корня, который посчитает массив высот $h$ ($h[i]$ - высота вершины, которая посещена на $i$-м такте) и массив $Order$, в котором $Order[i]$ - номер вершины, которая была посещена в такт $i$
2) $LCA(u, v) = Order[i]$ $\Leftrightarrow$ $h[i] = \min\limits_{t_{in}(u) \leq i \leq t_{in}(v)} h[i]$

#### Обоснование корректности 2-го пункта

боо $t_{in}(u) < t_{out}(v)$. Рассмотрим случаи:

1) $LCA(u, v) = u$
	По [[Лемма о белых путях|лемме о белых путях]] все вершины, для которых время перового посещения $t_{in}(u) \leq i \leq t_{in}(v)$ лежат в поддереве $u$ $\Rightarrow$ $h[u] = \min\limits_{t_{in}(u) \leq i \leq t_{in}(v)} h[i]$.

2) $LCA(u, v) = w \neq u$
	По [[Лемма о белых путях|лемме о белых путях]] $t_{in}(w) < t_{in}(u) < t_{out}(u) < t_{in}(v) < t_{out}(v) < t_{out}(w)$ (третье неравенство в силу того что они не могут быть lca друг друга). При этом между $t_{out}(u)$ и $t_{in}(v)$ можно подняться до $w$ (так как $u$ и $v$ в разных поддеревьях), но нельзя подняться выше (так как ещё не вышли из $w$).

## Сведение RMQ к LCA

1) На исследуемом массиве построим ДДНК, в котором приоритетом будет значение элемента

- Каждый подотрезок массива это подотрезок в обходе по порядку ДДНК, а значит он содержит внутри себя LCA.
- ДДНК является кучей по приоритетам

2) $RMQ(l, r) = LCA(l, r).priority$

### Оптимальное решение RMQ

1) Сведём RMQ к LCA (построим ДДНК).
2) Сведём LCA к RMQ на массиве высот.
3) Так как в нём соседние элементы отличаются не более чем на 1, то применим [[Алгоритм Фараха-Колтона-Бендера|алгоритм Фараха-Колтона-Бендера]] к массиву высот.
4) Приоритет найденной таким алгоритмом вершины ДДНК будет ответом.
