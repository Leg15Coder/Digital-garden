==Опр.== **Предпоток (в сети $\mathcal{N}$)** - функция вида $f : V^2 \to \mathbb{R}^+$ такая, что:
1. $\forall u, v \in V\ :\ 0 \leq f(u, v) \leq c(u, v)$
2. $\forall u \in V/\{s\}\ :\ \sum\limits_{v \in V} f(u, v) \leq \sum\limits_{v \in V} f(v, u)$

==Опр.== **Избыточный поток** - $e(u) = \sum\limits_{v \in V} f(v, u) - \sum\limits_{v \in V} f(u, v)$

==Опр.== **Переполненная вершина ($u$)** - $e(u) > 0$

==Опр.== **Высота (в сети $\mathcal{N}$)** - функция вида $h : V \to \mathbb{N}_0$ такая, что:
1. $h(s) = |V|$
2. $h(d) = 0$
3. $\forall$ потока $f\ \forall (u, v) \in E_f\ :\ h(u) < h(v)$

### Операция проталкивания предпотока

- Мы хотим протолкнуть предпоток из $u$ в $v$

1) Если $h(u) \neq h(v) + 1$ - протолкнуть нельзя.
2) $\Delta = \min\{e(u),\ c_f(u, v)\}$
3) Если $(u, v) \in E$, то $f(u, v)$ += $\Delta$
4) Иначе $f(v, u)$ -= $\Delta$
5) $e(u)$ -= $\Delta$
6) $e(v)$ += $\Delta$

==Опр.== **Насыщающее проталкивание** - после которого $c_f(u, v) = 0$

- **После НЕ насыщающего проталкивания $u$ перестаёт быть переполненной**. (Если проталкивание ненасыщающее, значит $c_f(u, v) > 0$, а значит $e(u)$ был меньше $c_f(u, v)$ на момент начала проталкивания. А значит $\Delta$ был равен $e(u)$, после вызова $e(u) = 0$)

### Операция подъёма предпотока

- Мы хотим поднять $u$ (подъём применяется только когда протолкнуть нельзя)

1) Если $e(u) = 0$, то предпотока нет и поднимать нечего
2) Если $\exists v$ - сосед $u$ такой, что $c_f(u, v) \neq 0$ и $h(u) > h(v)$, то не надо поднимать, достаточно протолкнуть в $v$.
3) Поднимаем $u$: $h(u) = \min\{h(v)\ |\ c_f(u, v) > 0\} + 1$
4) При необходимости делаем проталкивание из $u$

### Свойство переполненной вершины

- Если $u$ переполнена, то либо $\exists v$ такая, что относительно неё применимо проталкивание, либо $u$ можно поднять

#### Доказательство.

По определению высоты верно, что $\forall (u, v) \in E_f\ :\ h(u) \leq h(v) + 1$, Рассмотрим случаи:

1. $h(u) = h(v) + 1$ $\Rightarrow$ в силу того, что $(u, v)$ - обратное, можно протолкнуть предпоток из $u$ в $v$
2. $h(u) \leq h(v)$ $\Rightarrow$ так как $u$ переполнена, то её можно поднять.

### Лемма об инвариантах высоты

1) $\forall v \in V\ :\ h$ - не убывает.
2) $h$ - во время поднятия вершины строго увеличивается.
3) $h$ всегда остаётся функцией высоты (не теряет свойства).

#### Доказательства.

1-2 пункты верны так как $v$ была не выше всех детей, а стала выше хотя бы одного.

Докажем 3-й пункт:

1) $h(s) = |v|$ и $h(d) = 0$ остаются при любых операциях, так как они не участвуют в поднятии и проталкивании.
2) Остаточная сеть после инициализации содержит только обратные рёбра к рёбрам из истока, то есть рёбра вида $(v, s)$ - корректные.

Теперь рассмотрим операции

1) Проталкивание:
	1) При проталкивании у нас верно, что $h(u) = h(v) + 1$
		1) Проталкивание по прямому ребру $(u, v)$.
			В таком случае у нас добавляется обратное ребро $(v, u)$ в остаточной сети, которое удовлетворяет условию о высоте, так как вершины $u$ и $v$ не меняли свою высоту.
		
		2) Проталкивание по обратному ребру $(v, u)$.
			Тогда добавляем прямое ребро $(u, v)$ в остаточную сеть. Так как до этого в остаточной сети было ребро $(v, u)$, то предположим по индукции, что до этого всё было верно (если начинали с верного состояния - в нём останемся), о есть $h(u) < h(v)$ - отношение высот сохраняется.
	
	Таким образом, проталкивание предпотока не нарушает свойств высоты.

2) Подъём:
	1) Для всех прямых рёбер остаточной сети $(u, v)$:
		Новое $h(u) = 1 + \min\limits_{w} h(w) \leq h(v) + 1$ - свойство высоты сохраняется.
	
	2) Для обратных рёбер $(v, u)$: выполняется по индуктивному предположению (если начинали с верного состояния - в нём останемся): $h(v) \leq h_{old}(u) + 1 \leq h_{new}(u) + 1$.

	Таким образом, операция поднятия не нарушает свойств высоты.

### Лемма о блокирующем предпотоке

- Для любого предпотока выполняется, что в $\mathcal{N}_f$ нет пути из истока в сток.

#### Доказательство.

Пусть $p = (s, p_1, ..., p_{n-1}, d)$ - некоторый (боо - можем обрезать циклы для получения простого) простой (то есть $n < |V|$) путь из истока в сток в остаточной сети. Тогда в силу свойств высоты $\forall k \in \overline{0, n-1}\ :\ h(p_k) \leq h(p_{k+1}) + 1$ (с условным обозначением $p_0 = s$ и $p_n = d$). Сложим все неравенства вдоль пути: $|V| = h(s) \leq h(v_n) + n = h(d) + n = n$ - противоречие простоте пути.

### Лемма об инварианте переполненной вершины

- Если $e(x) > 0$, то есть путь из $x$ в исток по остаточной сети.

#### Доказательство.

Пусть $U = \{u\ |\ \text{в}\ \mathcal{N}_f\ \text{есть путь из}\ x\ \text{в}\ u\}$ ($x$ из условия леммы) Предположим, что $s \not\in U$, то есть $s \in U^C$. Тогда $\sum\limits_{u \in U} e(u) =$ $\sum\limits_{u \in U}(\sum\limits_{v \in V} f(v, u) - \sum\limits_{v \in V} f(u, v)) =$ $\sum\limits_{u \in U}((\sum\limits_{v \in U} f(v, u) + \sum\limits_{v \in U^C} f(v, u)) - (\sum\limits_{v \in U} f(u, v) + \sum\limits_{v \in U^C} f(u, v))) =$ $\sum\limits_{u \in U}\sum\limits_{v \in U} f(v, u) + \sum\limits_{u \in U}\sum\limits_{v \in U^C} f(v, u) - \sum\limits_{u \in U}\sum\limits_{v \in U} f(u, v) - \sum\limits_{u \in U}\sum\limits_{v \in U^C} f(u, v) =$ $\sum\limits_{u \in U}\sum\limits_{v \in U^C} f(v, u) - \sum\limits_{u \in U}\sum\limits_{v \in U^C} f(u, v)$ - эта сумма положительна, так как $e(x) > 0$, то есть $\forall v \in V/\{s\}\ :\ e(v) \geq 0$. Нет рёбер в остаточной сети из $U$ в $U^C$ нет (иначе бы $U^C$ было бы достижимо из $x$ по этому ребру и подпути в $U$), следовательно $f(v, u) = 0$ $\Rightarrow$ Так как $e(x) > 0$ и $x \in U$, то $0 < \sum\limits_{u \in U} e(u) = 0 - \sum\limits_{u \in U}\sum\limits_{v \in U^C} f(u, v) \leq 0$ - невозможно (предположение было неверным и $s$ достижима из $x$).

### Лемма об ограниченности высоты

- $\forall v \in V\ :\ h(v) \leq 2|V| - 1$

#### Доказательство.

Для истока и стока неравенство всегда очевидно верно. Рассмотрим остальные вершины.

Соотношение высот меняет только поднятие. Докажем, что каждое поднятие сохраняет истинности этого неравенства.

Пусть мы подняли вершину $v$. Это значит, что она была переполненной, значит по лемме об инварианте переполненной вершины $\exists$ путь из $v$ в $s$: $p = (v = v_0, v_1, ..., v_n = s)$. (боо путь простой, то есть $n < |V|$) Сложим вдоль этого пути неравенства для высоты: $h(v) = h(v_0) \leq h(v_n) + n = h(s) + n = |V| + n \leq 2|V| - 1$

## Поиск [[Понятия сети и потока|максимального потока]] по предпотоку

1) $\forall v \in V/\{s\}\ :\ h(v) = 0$
2) $h(s) = |V|,\ e(s) = +\infty$
3) $\forall v \in V/\{s\}\ :\ e(v) = 0$
4) Для каждого соседа ($v$) истока:
	1) $f(s, v) = c(s, v)$
	2) $e(v) = f(s, v)$
	3) $e(s)$ -= $f(s, v)$
5) Пока есть допустимая операция проталкивания или подъёма, выполняем её

### Обоснование корректности

Докажем по индукции по операциям проталкивания и подъёма.

База: Первые 4 пункта алгоритма делают $f$ корректным предпотоком.

Переход: По лемме об инварианте высоты, она сохраняет свои свойства, а следовательно и $f$ остаётся предпотоком.

После завершения алгоритма $\forall v \in V/\{s, d\}\ :\ e(v) = 0$ $\Rightarrow$ $f$ - стал потоком. При этом $h$ осталась высотой, следовательно, по лемме о блокирующем предпотоке в $\mathcal{N}_f$ нет пути из истока в сток, то есть по [[Теорема Форда-Фалкерсона|Т. Форда-Фалкерсона]] $f$ - максимальный поток.

**Асимптотика по времени**: $O(|V|^2|E|)$

### Обоснование асимптотики

Из леммы об ограниченности высоты: Число операций подъёма не превосходит $(|V| - 2)(2|V| - 1) = O(|V|^2)$.

При этом число насыщенных проталкиваний $< 2|V||E|$ ($= O(|V||E|)$):
	Рассмотрим сколько может быть насыщающих проталкиваний для ребра $(u, v)$ (или обратного ему):
		1) Пусть насыщение было из $u$ в $v$. На момент первого проталкивания соотношение высот было $h(v) = h(u) - 1$, а на момент второго - $h(v) = h(u) + 1$. То есть $v$ поднялась хотя бы на 2
		2) Аналогично и для насыщения из $v$ в $u$. ($u$ поднимается хотя бы на 2)
	По лемме об ограниченности высоты $\forall v \in V\ :\ h(v) \leq 2|V| - 1$ $\Rightarrow$ пар насыщающих проталкиваний не более $2|V|$. Это верно для каждого ребра, то есть всего насыщенных проталкиваний не более $2|V||E|$.

А число ненасыщающих проталкиваний $< 4|V|^2(|V| + |E|)$ ($= O(|V|^2|E|)$):
	1) Введём потенциал $\varphi(\mathcal{N}) = \sum\limits_{e(v) > 0}h(v)$, тогда $\varphi(\mathcal{N}) \geq 0$ всегда.
	2) Подъём не меняет предпоток, значит $\Delta \varphi < 2|V|$. (по лемме об ограниченности высоты)
	3) Насыщающее проталкивание может переполнить $v$, при этом оставив $u$ переполненной, то есть в потенциал добавляется одна вершина и $\Delta \varphi < 2|V|$.
	4) Рассмотрим ненасыщающее проталкивание. До него: $e(u) > 0,\ e(v) \geq 0$, после: $e(u) = 0,\ e(v) \geq 0$, то есть: либо $\Delta \varphi = h(v) - h(u) = -1$, либо $\Delta \varphi = 0 - h(u) = -1 - h(v) \leq -1$ - потенциал строго убывает
	Итог: потенциал суммарно вырастет (по доказанному выше ограничению на число насыщающих проталкиваний и ограничения на высоту, то есть количества подъёмов) не более чем на $2|V|(2|V||E| + 2|V|^2) = O(|V|^2|E|)$, а так как он не может упасть ниже нуля, то это и есть ограничение на максимальное количество ненасыщающих проталкиваний.

Подведём итог: первые 4 шага алгоритма выполняются за $O(|V| + \deg s) = O(|V| + |E|)$. В пятом шаге общее число операций равно $O(|V|^2 + |V||E| + |V|^2|E|) = O(|V|^2|E|)$ - доказано.
