==Опр.== **Медиана в массиве (размера $n$)** - это его $\frac{n}{2}$-я [[Порядковая статистика|порядковая статистика]].

- ***Алгоритм медианы медиан ищет оптимальный $pivot$ для быстрой сортировки. Такой $pivot$ называется медиана медиан.***

## Алгоритм

Алгоритм рекурсивный:
1) Если размер массива меньше либо равен 5, то ищем в нём медиану "вручную" (перебором) и возвращаем её - *тривиальный случай*
2) Делим массив на блоки по 5 элементов (последний блок может иметь размер меньше)
3) Для каждого блока применяем алгоритм медианы медиан рекурсивно. Получаем $\frac{n}{5}$ чисел
4) На массиве из полученных чисел запускаем алгоритм поиска $\frac{n}{2}$-й порядковой статистики, но в качестве $pivot$ используем не случайное число, а медиану медиан, применяя данный алгоритм на том массиве
5) Результат поиска $\frac{n}{2}$-й порядковой статистики и будет ответом

![[Pasted image 20250724150711.png]]

- *Не имеет смысла рассматривать корректность, так как это лишь один из нескольких способов выбрать опорный элемент. Сразу рассмотрим почему с таким опорным элементом асимптотика становится лучше.*

## Асимптотика

Условно отсортируем созданные нами блоки из 5-ти элементов по их медиане (как на рисунке). Тогда около $\frac{n}{10}$ блоков будут стоять левее блока с медианой медиан. И в каждом таком блоке гарантированно 3 элемента будут меньше медианы медиан (медиана этого блока + 2 элемента с 1-й и 2-й порядковыми статистиками). То есть гарантированно 30% элементов исходного массива будут меньше медианы медиан.

Повторяя данные рассуждения для элементов правее и больше медианы медиан, можно получить, что гарантированно 30% элементов исходного массива будут больше медианы медиан.

Таким образом, медиана медиан делит исходный массив в отношении, которое попадает в отрезок $[\frac{3}{7};\ \frac{1}{2}]$ (с точностью до перестановки частей).

![[Pasted image 20250724150727.png]]
*На рисунке красным показана медиана медиан, серым - элементы меньше неё, белым - элементы больше.*

Пусть $T(n)$ - время работы алгоритма медианы медиан. 
Тривиальный случай считается за $O(1)$ (можно просто сделать конструкцию `if-else`).
Разбиение на блоки и нахождение в каждом блоке медианы суммарно работает за $O(n)$.
Далее на блоках из пяти элементов происходят глобально две операции: выбор $pivot$ за $T(\frac{n}{5})$ и расчёт порядковой статистики на одном из блоков. А так как размер большего из блоков не превосходит 70% от $n$, то дальнейший поиск статистики не дольше чем $T(\frac{7n}{10}) + O(\frac{7n}{10})$.

**Итого**: $T(n) \leq$ $O(n) + T(\frac{n}{5}) + T(\frac{7n}{10})$ $\leq C_1 \cdot n + T(\frac{n}{5}) + T(\frac{7n}{10})$ ($C_1$ из определения $O$-большого).

Докажем по индукции, что $T(n)$ ограничена $O(n)$:

**База**: при $n \leq 5$ очевидно выполняется (этот случай вообще обрабатывается за $O(1)$)

**Предположение**: $\exists C_2 > 0\ \forall k < n\ :\ T(k) \leq C_2 \cdot k$

**Шаг**: $T(n) \leq C_1 \cdot n + T(\frac{n}{5}) + T(\frac{7n}{10})$ $\leq C_1 \cdot n + C_2 \cdot \frac{n}{5} +  C_2 \cdot \frac{7n}{10}$ $\leq C_3 \cdot \frac{19n}{10} \leq C \cdot n$ - для рассматриваемого $n$ такая константа тоже существует. То есть $T(n) = O(n)$.

**Итоговая асимптотика по времени**: $O(n)$.

### Замечания

1) Возможно появится вопрос почему блоки именно по 5 элементов: вам предлагается проверить оптимальность этого разбиения эмпирическим путём.
2) Возможно будет ещё один вопрос: зачем такие сложные махинации, если мы уже умеем выбирать случайный $pivot$ за $O(1)$, в чём тут выгода?
	- Во-первых, заметим что ни в быстрой сортировке, ни в поиске порядковой статистике такой выбор $pivot$ не влияет на итоговую асимптотику, так как всё равно на каждой итерации алгоритма требуется $O(n)$ времени на разбиение по блокам. То есть, на бесконечности с $pivot$ медианой медиан и случайным $pivot$ алгоритм будет работать одинаково.
	- Во-вторых, до этого из-за "отсутствия везения" в выборе опорного элемента алгоритмы могли вырождаться до $O(n^2)$, сейчас же если запускать быстрою сортировку с $pivot$, выбранным как медиана, то согласно Мастер-Теореме, так как каждый раз части будут примерно равные, $T(n) \leq 2T(n) + O(n) = O(n \log n)$, то есть быстрая сортировка будет гарантированно работать с лучшей асимптотикой.
