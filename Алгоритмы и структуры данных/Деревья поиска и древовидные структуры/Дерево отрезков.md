==Опр.== **Дерево отрезков (ДО)** - [[Понятие графа|древовидная]] структура данных, применяющая ассоциативную операцию на любом подотрезке отрезка (решает задачи [[Задачи RMQ и RSQ|dynamic RMQ]] и [[Задачи RMQ и RSQ|dynamic RSQ]]).

![[Pasted image 20250727195935.png]]

## Структура

- *Для определённости будем говорить про дерево отрезков на сумму.*

В идеале сделать дерево двоичным (у каждого узла, кроме листьев, ровно два ребёнка). Для этого следует поставить во все недостающие узлы нейтральный элемент (для суммы это 0).

Каждый узел дерева содержит в себе информацию о сумме на отрезке длины $2^k\ (k \in \mathbb{Z})$. Корень дерева считает сумму на всём отрезке. Левый ребёнок каждого узла считает сумму на первой половине отрезка родителя, правый ребёнок - на второй.

Для удобства реализации узлы занумерованы (для быстрого обращения по индексу): корень имеет номер $0$, у узла с номером $k$ номерами его левого и правого ребёнка являются $2k+1$ и $2k+2$ соответственно.

## Инициализация

Создаётся динамический массив узлов размера $4n$, где $n$ - начальное количество элементов на отрезке. С помощью рекурсии начинается заполнение дерева:

Пусть $l = 0,\ r = n + 1,\ x = 0$ - входные данные рекурсии, $t$ - динамический массив ДО, а $a$ - изначальный массив (отрезок из задачи), тогда
1) Если $r - l = 1$, то $t_x = a_l$ (если $l < n$, иначе $t_x = e$ (в нашем случае $e = 0$)) и мы выходим из рекурсии
2) $m = \lfloor \frac{l + r}{2} \rfloor$
3) Запускаем рекурсию с $l = l,\ r = m,\ x = 2x + 1$
4) Запускаем рекурсию с $l = m,\ r = r,\ x = 2x + 2$
5) $t_x = t_{2x + 1} \circ t_{2x+2}$ (в нашем случае $\circ\ =\ +$)

## Ответ на запрос



## Отложенные операции и проталкивание

## Асимптотика

**По памяти**: $O(n)$

**По времени**:
1) **Предподсчёт**: $O(n)$
2) **Ответ на запрос**: $O^*(\log n)$
3) **Аллокация**: $O(n)$
